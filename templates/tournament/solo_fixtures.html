{% extends "base.html" %}

{% block title %}Solo Matches - {{ tournament.name }} - Kickoff Arena{% endblock %}

{% block main_class %}pt-16{% endblock %}

{% block extra_head %}
<style>
    .hero-gradient {
        background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 25%, #99f6e4 50%, #5eead4 75%, #2dd4bf 100%);
        position: relative;
        overflow: hidden;
    }
    .floating-shape {
        position: absolute;
        opacity: 0.08;
        animation: float 6s ease-in-out infinite;
    }
    .floating-shape:nth-child(1) { top: 15%; left: 10%; }
    .floating-shape:nth-child(2) { top: 50%; right: 15%; animation-delay: 1s; }
    .floating-shape:nth-child(3) { bottom: 10%; left: 30%; animation-delay: 2s; }
    @keyframes float { 0%,100%{ transform: translateY(0)} 50%{ transform: translateY(-10px)} }
    .feature-card { background: linear-gradient(135deg,#fff 0%,#f8fafc 100%); border: 1px solid rgba(16,185,129,.1); transition: all .3s ease; }
    .feature-card:hover { transform: translateY(-2px); box-shadow: 0 20px 40px rgba(16,185,129,.08); border-color: rgba(16,185,129,.2); }
    .match-card { background: linear-gradient(135deg,#fff 0%,#f8fafc 100%); border: 1px solid rgba(16,185,129,.05); transition: all .3s ease; }
    .match-card:hover { transform: translateY(-1px); box-shadow: 0 10px 25px rgba(16,185,129,.06); }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Hero Header -->
    <div class="hero-gradient border-b border-green-100">
        <!-- Floating Background Shapes -->
        <div class="floating-shape w-16 h-16 bg-white rounded-full"></div>
        <div class="floating-shape w-12 h-12 bg-yellow-300 rounded-full"></div>
        <div class="floating-shape w-20 h-20 bg-white rounded-full"></div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Breadcrumb -->
            <nav class="flex text-sm text-gray-600 mb-4" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2">
                    <li><a href="{{ url_for('main.index') }}" class="hover:text-gray-900"><i class="fas fa-home"></i></a></li>
                    <li><i class="fas fa-chevron-right text-gray-400 text-[10px] mx-2"></i></li>
                    <li><a href="{{ url_for('tournament.view', tournament_id=tournament.id) }}" class="hover:text-gray-900">{{ tournament.name }}</a></li>
                    <li><i class="fas fa-chevron-right text-gray-400 text-[10px] mx-2"></i></li>
                    <li class="text-gray-900 font-semibold">Solo Matches</li>
                </ol>
            </nav>
            
            <!-- Header Content -->
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-user text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-black text-gray-900">Solo Matches</h1>
                        <p class="text-gray-700">1v1 tournament fixtures for <span class="font-semibold text-green-600">{{ tournament.name }}</span></p>
                    </div>
                </div>
                
                {% if is_organizer %}
                <div class="flex items-center space-x-3">
                    <button id="generateFixturesBtn" 
                            class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-lg">
                        <i class="fas fa-magic mr-2"></i>Generate Fixtures
                    </button>
                </div>
                {% endif %}
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
                <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-green-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-black text-gray-900">{{ participants|length }}</div>
                            <div class="text-gray-600 text-sm font-semibold">Participants</div>
                        </div>
                        <div class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-blue-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-black text-gray-900">{{ matches|length }}</div>
                            <div class="text-gray-600 text-sm font-semibold">Total Matches</div>
                        </div>
                        <div class="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-gamepad"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-green-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-black text-gray-900">{{ completed_matches }}</div>
                            <div class="text-gray-600 text-sm font-semibold">Completed</div>
                        </div>
                        <div class="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-white/80 backdrop-blur-sm rounded-xl p-4 border border-yellow-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-black text-gray-900">{{ upcoming_matches }}</div>
                            <div class="text-gray-600 text-sm font-semibold">Upcoming</div>
                        </div>
                        <div class="w-10 h-10 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-clock"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% if matches %}
        <!-- Solo Matches by Round -->
        {% set matches_by_round = {} %}
        {% for match in matches %}
            {% set round = match.round or 1 %}
            {% if round not in matches_by_round %}
                {% set _ = matches_by_round.update({round: []}) %}
            {% endif %}
            {% set _ = matches_by_round[round].append(match) %}
        {% endfor %}

        {% for round_num in matches_by_round.keys()|sort %}
        <div class="mb-8">
            <div class="feature-card rounded-2xl overflow-hidden">
                <!-- Round Header -->
                <div class="px-6 py-4 bg-gradient-to-r from-green-50 to-green-100 border-b border-green-200">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-black text-gray-900 flex items-center">
                            <i class="fas fa-trophy text-green-600 mr-2"></i>
                            {% if tournament.format == 'single_elimination' or tournament.format == 'double_elimination' %}
                                {% if round_num == 1 %}Round 1{% elif round_num == 2 %}Semifinals{% elif round_num == 3 %}Final{% else %}Round {{ round_num }}{% endif %}
                            {% else %}
                                Round {{ round_num }}
                            {% endif %}
                        </h2>
                        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-semibold">{{ matches_by_round[round_num]|length }} matches</span>
                    </div>
                </div>
                
                <!-- Matches in this round -->
                <div class="divide-y divide-gray-50">
                    {% for match in matches_by_round[round_num] %}
                    <div class="px-6 py-5 match-card transition-all">
                        <div class="flex items-center justify-between">
                            <!-- Participants -->
                            <div class="flex items-center space-x-6 flex-1">
                                <!-- Participant 1 -->
                                <div class="flex items-center space-x-3 flex-1">
                                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-sm">
                                        <span class="text-white font-bold">{{ match.participant1_name[:2]|upper if match.participant1_name else 'P1' }}</span>
                                    </div>
                                    <div class="flex-1">
                                        <div class="font-bold text-gray-900">{{ match.participant1_name or 'TBD' }}</div>
                                        {% if match.participant1 and match.participant1.gamer_tag %}
                                        <div class="text-sm text-gray-500">@{{ match.participant1.gamer_tag }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- VS and Score -->
                                <div class="text-center px-6">
                                    {% if match.status == 'completed' %}
                                    <div class="text-2xl font-black text-gray-800 bg-gray-100 rounded-lg px-4 py-2">{{ match.participant1_score or 0 }} - {{ match.participant2_score or 0 }}</div>
                                    {% else %}
                                    <div class="text-lg font-bold text-gray-400 bg-gray-50 rounded-lg px-4 py-2">vs</div>
                                    {% endif %}
                                </div>
                                
                                <!-- Participant 2 -->
                                <div class="flex items-center space-x-3 flex-1 justify-end">
                                    <div class="flex-1 text-right">
                                        <div class="font-bold text-gray-900">{{ match.participant2_name or 'TBD' }}</div>
                                        {% if match.participant2 and match.participant2.gamer_tag %}
                                        <div class="text-sm text-gray-500">@{{ match.participant2.gamer_tag }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-sm">
                                        <span class="text-white font-bold">{{ match.participant2_name[:2]|upper if match.participant2_name else 'P2' }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Status and Actions -->
                            <div class="ml-6 text-right">
                                <div class="mb-3">
                                    <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-bold
                                        {% if match.status == 'scheduled' %}bg-yellow-100 text-yellow-800{% endif %}
                                        {% if match.status == 'in_progress' %}bg-blue-100 text-blue-800{% endif %}
                                        {% if match.status == 'completed' %}bg-green-100 text-green-800{% endif %}">
                                        <i class="fas {% if match.status == 'scheduled' %}fa-clock{% elif match.status == 'in_progress' %}fa-play{% else %}fa-check{% endif %} mr-1 text-xs"></i>
                                        {{ match.status|replace('_', ' ')|title }}
                                    </span>
                                </div>
                                
                                {% if is_organizer %}
                                <div class="flex space-x-2 justify-end">
                                    {% if match.status != 'completed' %}
                                    <button onclick="editMatch('{{ match.id }}')" 
                                            class="bg-blue-50 text-blue-700 hover:bg-blue-100 px-3 py-1.5 rounded-lg text-xs font-semibold transition-colors">
                                        <i class="fas fa-edit mr-1"></i>Edit
                                    </button>
                                    {% endif %}
                                    {% if match.status == 'completed' %}
                                    <button onclick="resetMatch('{{ match.id }}')" 
                                            class="bg-orange-50 text-orange-700 hover:bg-orange-100 px-3 py-1.5 rounded-lg text-xs font-semibold transition-colors">
                                        <i class="fas fa-undo mr-1"></i>Reset
                                    </button>
                                    {% endif %}
                                    <button onclick="deleteMatch('{{ match.id }}')" 
                                            class="bg-red-50 text-red-700 hover:bg-red-100 px-3 py-1.5 rounded-lg text-xs font-semibold transition-colors">
                                        <i class="fas fa-trash mr-1"></i>Delete
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if match.match_date %}
                        <div class="mt-3 pt-3 border-t border-gray-100">
                            <div class="flex items-center text-sm text-gray-500">
                                <i class="fas fa-calendar text-green-500 mr-2"></i>
                                <span class="font-semibold">{{ match.match_date }}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% else %}
        <!-- Enhanced Empty State -->
        <div class="text-center py-16">
            <div class="max-w-md mx-auto">
                <div class="w-24 h-24 bg-gradient-to-br from-green-100 to-green-200 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg">
                    <i class="fas fa-calendar-alt text-green-600 text-3xl"></i>
                </div>
                <h3 class="text-xl font-black text-gray-900 mb-3">No Matches Scheduled Yet</h3>
                <p class="text-gray-600 mb-8 leading-relaxed">Generate fixtures to create 1v1 matches for your solo tournament. The system will automatically pair participants and create the bracket structure.</p>
                
                {% if is_organizer %}
                <button id="generateFixturesEmptyBtn" 
                        class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white font-bold py-3 px-8 rounded-lg transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-lg">
                    <i class="fas fa-magic mr-2"></i>Generate Solo Fixtures
                </button>
                <p class="text-xs text-gray-500 mt-3">This will create matches based on your tournament format</p>
                {% else %}
                <div class="bg-gray-50 rounded-lg p-4 text-sm text-gray-600">
                    <i class="fas fa-info-circle text-gray-400 mr-2"></i>
                    Only the tournament organizer can generate fixtures
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Edit Match Modal -->
<div id="editMatchModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 backdrop-blur-sm">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full border border-green-100">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-black text-gray-900 flex items-center">
                        <i class="fas fa-edit text-green-600 mr-3"></i>
                        Edit Solo Match
                    </h3>
                    <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="editMatchForm">
                    <input type="hidden" id="editMatchId">
                    
                    <!-- Participants Display -->
                    <div class="mb-6">
                        <div class="bg-gray-50 rounded-xl p-4">
                            <div class="flex items-center justify-center space-x-6">
                                <div class="text-center">
                                    <div class="w-14 h-14 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mx-auto mb-2 shadow-sm">
                                        <span class="text-white font-bold" id="editParticipant1Initial">P1</span>
                                    </div>
                                    <div class="font-bold text-sm" id="editParticipant1Name">Player 1</div>
                                </div>
                                <div class="text-gray-400 font-bold text-lg">VS</div>
                                <div class="text-center">
                                    <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mx-auto mb-2 shadow-sm">
                                        <span class="text-white font-bold" id="editParticipant2Initial">P2</span>
                                    </div>
                                    <div class="font-bold text-sm" id="editParticipant2Name">Player 2</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scores -->
                    <div class="mb-5">
                        <label class="block text-sm font-bold text-gray-700 mb-3">Match Result</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-2" id="editScore1Label">Player 1 Score</label>
                                <input type="number" id="editScore1" min="0" max="20" 
                                       class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-gray-600 mb-2" id="editScore2Label">Player 2 Score</label>
                                <input type="number" id="editScore2" min="0" max="20" 
                                       class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Match Status -->
                    <div class="mb-5">
                        <label for="editStatus" class="block text-sm font-bold text-gray-700 mb-2">Status</label>
                        <select id="editStatus" 
                                class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
                            <option value="scheduled">Scheduled</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    
                    <!-- Match Date -->
                    <div class="mb-6">
                        <label for="editMatchDate" class="block text-sm font-bold text-gray-700 mb-2">Match Date (Optional)</label>
                        <input type="datetime-local" id="editMatchDate" 
                               class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all">
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex items-center justify-end space-x-3">
                        <button type="button" onclick="closeEditModal()" 
                                class="px-6 py-2.5 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white font-bold py-2.5 px-6 rounded-lg transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i>Save Match
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Match Confirmation Modal -->
<div id="deleteMatchModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 backdrop-blur-sm">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full border border-red-100">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-black text-gray-900 flex items-center">
                        <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                        Delete Match
                    </h3>
                    <button onclick="closeDeleteModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <div class="bg-red-50 rounded-xl p-4 mb-4">
                        <div class="flex items-center">
                            <i class="fas fa-warning text-red-500 text-xl mr-3"></i>
                            <div>
                                <h4 class="font-bold text-red-800 mb-1">This action cannot be undone</h4>
                                <p class="text-red-700 text-sm">The match will be permanently deleted from the tournament.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Match Details -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center justify-center space-x-4">
                            <div class="text-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center mx-auto mb-2">
                                    <span class="text-white font-bold text-sm" id="deleteParticipant1Initial">P1</span>
                                </div>
                                <div class="font-semibold text-xs text-gray-700" id="deleteParticipant1Name">Player 1</div>
                            </div>
                            <div class="text-gray-400 font-bold">VS</div>
                            <div class="text-center">
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mx-auto mb-2">
                                    <span class="text-white font-bold text-sm" id="deleteParticipant2Initial">P2</span>
                                </div>
                                <div class="font-semibold text-xs text-gray-700" id="deleteParticipant2Name">Player 2</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" onclick="closeDeleteModal()" 
                            class="px-6 py-2.5 text-sm font-semibold text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                        Cancel
                    </button>
                    <button type="button" onclick="confirmDeleteMatch()" 
                            class="bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 text-white font-bold py-2.5 px-6 rounded-lg transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-lg">
                        <i class="fas fa-trash mr-2"></i>Delete Match
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Fixtures Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 backdrop-blur-sm">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full border border-green-100">
            <div class="p-8">
                <div class="text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-black text-gray-900 mb-2">Fixtures Generated!</h3>
                    <p class="text-gray-600 mb-6">
                        <span id="matchesCreatedText">Successfully generated matches for your solo tournament.</span>
                    </p>
                </div>
            </div>
            <div class="bg-green-50 px-6 py-4 text-center rounded-b-2xl">
                <button onclick="closeSuccessModal()" class="bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white font-bold py-2.5 px-8 rounded-lg transition-all duration-300 transform hover:-translate-y-0.5 hover:shadow-lg">
                    <i class="fas fa-check mr-2"></i>Perfect!
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Generate fixtures functionality
function generateFixtures() {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
    
    fetch(`/tournament/{{ tournament.id }}/generate-solo-fixtures`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success) {
            document.getElementById('matchesCreatedText').textContent = 
                `Successfully generated ${data.matches_created} match${data.matches_created !== 1 ? 'es' : ''}!`;
            document.getElementById('successModal').classList.remove('hidden');
            
            // Reload page after a short delay
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert('Error: ' + (data.error || 'Failed to generate fixtures'));
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('Error generating fixtures: ' + error.message);
    });
}

function closeSuccessModal() {
    document.getElementById('successModal').classList.add('hidden');
    window.location.reload();
}

// Edit match functionality
function editMatch(matchId) {
    // Fetch match details
    fetch(`/tournament/{{ tournament.id }}/solo-matches/${matchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const match = data.match;
                
                // Populate modal with match data
                document.getElementById('editMatchId').value = matchId;
                document.getElementById('editParticipant1Name').textContent = match.participant1_name || 'Player 1';
                document.getElementById('editParticipant2Name').textContent = match.participant2_name || 'Player 2';
                document.getElementById('editParticipant1Initial').textContent = (match.participant1_name || 'P1').slice(0, 2).toUpperCase();
                document.getElementById('editParticipant2Initial').textContent = (match.participant2_name || 'P2').slice(0, 2).toUpperCase();
                document.getElementById('editScore1Label').textContent = (match.participant1_name || 'Player 1') + ' Score';
                document.getElementById('editScore2Label').textContent = (match.participant2_name || 'Player 2') + ' Score';
                
                // Set current values
                document.getElementById('editScore1').value = match.participant1_score || '';
                document.getElementById('editScore2').value = match.participant2_score || '';
                document.getElementById('editStatus').value = match.status || 'scheduled';
                
                // Set match date if available (database uses scheduled_date)
                if (match.scheduled_date) {
                    const date = new Date(match.scheduled_date);
                    document.getElementById('editMatchDate').value = date.toISOString().slice(0, 16);
                } else {
                    document.getElementById('editMatchDate').value = '';
                }
                
                // Show modal
                document.getElementById('editMatchModal').classList.remove('hidden');
            } else {
                alert('Error loading match: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error loading match: ' + error.message);
        });
}

function closeEditModal() {
    document.getElementById('editMatchModal').classList.add('hidden');
}

// Handle edit form submission
function handleEditSubmit(event) {
    event.preventDefault();
    
    const matchId = document.getElementById('editMatchId').value;
    const formData = {
        participant1_score: document.getElementById('editScore1').value || null,
        participant2_score: document.getElementById('editScore2').value || null,
        status: document.getElementById('editStatus').value,
        match_date: document.getElementById('editMatchDate').value || null
    };
    
    // Convert empty strings to null
    if (formData.participant1_score === '') formData.participant1_score = null;
    if (formData.participant2_score === '') formData.participant2_score = null;
    if (formData.match_date === '') formData.match_date = null;
    
    fetch(`/tournament/{{ tournament.id }}/solo-matches/${matchId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEditModal();
            window.location.reload();
        } else {
            alert('Error updating match: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error updating match: ' + error.message);
    });
}

// Reset match functionality  
function resetMatch(matchId) {
    if (confirm('Are you sure you want to reset this match? This will clear all scores and set status to scheduled.')) {
        fetch(`/tournament/{{ tournament.id }}/solo-matches/${matchId}/reset`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error: ' + (data.error || 'Failed to reset match'));
            }
        })
        .catch(error => {
            alert('Error resetting match: ' + error.message);
        });
    }
}

// Store match ID for deletion
let matchToDelete = null;

// Delete match functionality - show modal
function deleteMatch(matchId) {
    // Store the match ID
    matchToDelete = matchId;
    
    // Fetch match details to show in the confirmation modal
    fetch(`/tournament/{{ tournament.id }}/solo-matches/${matchId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const match = data.match;
                
                // Populate modal with match data
                document.getElementById('deleteParticipant1Name').textContent = match.participant1_name || 'Player 1';
                document.getElementById('deleteParticipant2Name').textContent = match.participant2_name || 'Player 2';
                document.getElementById('deleteParticipant1Initial').textContent = (match.participant1_name || 'P1').slice(0, 2).toUpperCase();
                document.getElementById('deleteParticipant2Initial').textContent = (match.participant2_name || 'P2').slice(0, 2).toUpperCase();
                
                // Show modal
                document.getElementById('deleteMatchModal').classList.remove('hidden');
            } else {
                alert('Error loading match details: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error loading match details: ' + error.message);
        });
}

// Close delete confirmation modal
function closeDeleteModal() {
    document.getElementById('deleteMatchModal').classList.add('hidden');
    matchToDelete = null;
}

// Actually delete the match after confirmation
function confirmDeleteMatch() {
    if (!matchToDelete) return;
    
    const deleteBtn = document.querySelector('#deleteMatchModal button[onclick="confirmDeleteMatch()"]');
    const originalText = deleteBtn.innerHTML;
    
    // Show loading state
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
    
    fetch(`/tournament/{{ tournament.id }}/solo-matches/${matchToDelete}/delete`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
        
        if (data.success) {
            closeDeleteModal();
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to delete match'));
        }
    })
    .catch(error => {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
        alert('Error deleting match: ' + error.message);
    });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateFixturesBtn');
    const generateEmptyBtn = document.getElementById('generateFixturesEmptyBtn');
    const editForm = document.getElementById('editMatchForm');
    
    if (generateBtn) {
        generateBtn.addEventListener('click', generateFixtures);
    }
    
    if (generateEmptyBtn) {
        generateEmptyBtn.addEventListener('click', generateFixtures);
    }
    
    if (editForm) {
        editForm.addEventListener('submit', handleEditSubmit);
    }
});
</script>
{% endblock %}
